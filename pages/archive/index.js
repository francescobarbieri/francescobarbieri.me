import Head from 'next/head';
import ArticlesCollection from '../../components/ArticlesCollection';
import Navbar from '../../components/Navbar';
import TagSelector from '../../components/TagSelector';
import { useState } from 'react';
import Newsletter from '../../components/Newsletter';
import Footer from '../../components/Footer';
import { collection, getDocs, query, orderBy, limit } from "firebase/firestore";
import { format } from 'date-fns';
import { db } from '../../components/firebase';

export default function Home(props) {
  
  // change this name
  const { output } = props;

  const [selectedTag, setSelectedTag] = useState();

  return (
    <>
      <Head>
        <meta charSet='utf-8' />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        
        <meta name="description" content="Generated by create next app" />

        <title>Francesco Barbieri - Archive</title>
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <center>
        <div className='wrapper'>
          <Navbar />
          <TagSelector setTag={setSelectedTag}/>
          <ArticlesCollection pages={true} articles={output} currentTag={selectedTag}/>
          <Newsletter />
          <Footer />
        </div>
      </center>
    </>
  )
}

// Gestire potenziali errori da questa funzione

export async function getServerSideProps () {

  try {
      const q = query(collection(db, 'articles'), orderBy("date", "desc"));
      const querySnapshot = await getDocs(q);
  
      let output = [];
  
      querySnapshot.docs.map( doc => {
        output.push(
              {
                  id: doc.id,
                  date: format(doc.data().date.toDate() , 'MMMM d, yyyy'),
                  tag: doc.data().tag,
                  title: doc.data().title,
                  preview: doc.data().preview,
                  mainImg: doc.data().mainImg
              }
          )
      })

      return { props: {output}}
  } catch(e) {
      return { props: {}}
  }

}